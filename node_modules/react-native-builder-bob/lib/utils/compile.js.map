{"version":3,"file":"compile.js","names":["_path","_interopRequireDefault","require","_fsExtra","_kleur","babel","_interopRequireWildcard","_browserslist","_glob","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","compile","root","source","output","babelrc","configFile","exclude","modules","copyFlow","sourceMaps","report","field","files","glob","sync","cwd","absolute","nodir","ignore","info","kleur","blue","String","length","path","relative","pkg","JSON","parse","fs","readFile","join","keys","devDependencies","includes","warn","Promise","all","map","filepath","outputFilename","replace","mkdirp","dirname","test","copy","content","result","transformAsync","sourceRoot","sourceFileName","filename","presets","resolve","targets","browserslist","findConfig","browsers","node","useBuiltIns","Error","code","mapFilename","basename","sourcesContent","undefined","writeJSON","writeFile","success","getGeneratedEntryPath","indexName","potentialPath","pathExists","e","generatedEntryPath","error"],"sources":["../../src/utils/compile.ts"],"sourcesContent":["import path from 'path';\nimport fs from 'fs-extra';\nimport kleur from 'kleur';\nimport * as babel from '@babel/core';\nimport browserslist from 'browserslist';\nimport glob from 'glob';\nimport type { Input } from '../types';\n\ntype Options = Input & {\n  babelrc?: boolean | null;\n  configFile?: string | false | null;\n  sourceMaps?: boolean;\n  copyFlow?: boolean;\n  modules: 'commonjs' | false;\n  field: 'main' | 'module';\n  exclude: string;\n};\n\nexport default async function compile({\n  root,\n  source,\n  output,\n  babelrc = false,\n  configFile = false,\n  exclude,\n  modules,\n  copyFlow,\n  sourceMaps = true,\n  report,\n  field,\n}: Options) {\n  const files = glob.sync('**/*', {\n    cwd: source,\n    absolute: true,\n    nodir: true,\n    ignore: exclude,\n  });\n\n  report.info(\n    `Compiling ${kleur.blue(String(files.length))} files in ${kleur.blue(\n      path.relative(root, source)\n    )} with ${kleur.blue('babel')}`\n  );\n\n  const pkg = JSON.parse(\n    await fs.readFile(path.join(root, 'package.json'), 'utf-8')\n  );\n\n  if (copyFlow) {\n    if (!Object.keys(pkg.devDependencies || {}).includes('flow-bin')) {\n      report.warn(\n        `The ${kleur.blue(\n          'copyFlow'\n        )} option was specified, but couldn't find ${kleur.blue(\n          'flow-bin'\n        )} in ${kleur.blue(\n          'package.json'\n        )}.\\nIf the project is using ${kleur.blue(\n          'flow'\n        )}, then make sure you have added ${kleur.blue(\n          'flow-bin'\n        )} to your ${kleur.blue(\n          'devDependencies'\n        )}, otherwise remove the ${kleur.blue('copyFlow')} option.`\n      );\n    }\n  }\n\n  await Promise.all(\n    files.map(async (filepath) => {\n      const outputFilename = path\n        .join(output, path.relative(source, filepath))\n        .replace(/\\.(jsx?|tsx?)$/, '.js');\n\n      await fs.mkdirp(path.dirname(outputFilename));\n\n      if (!/\\.(jsx?|tsx?)$/.test(filepath)) {\n        // Copy files which aren't source code\n        fs.copy(filepath, outputFilename);\n        return;\n      }\n\n      const content = await fs.readFile(filepath, 'utf-8');\n      const result = await babel.transformAsync(content, {\n        cwd: root,\n        babelrc: babelrc,\n        configFile: configFile,\n        sourceMaps,\n        sourceRoot: path.relative(path.dirname(outputFilename), source),\n        sourceFileName: path.relative(source, filepath),\n        filename: filepath,\n        ...(babelrc || configFile\n          ? null\n          : {\n              presets: [\n                [\n                  require.resolve('@babel/preset-env'),\n                  {\n                    targets: browserslist.findConfig(root) ?? {\n                      browsers: [\n                        '>1%',\n                        'last 2 chrome versions',\n                        'last 2 edge versions',\n                        'last 2 firefox versions',\n                        'last 2 safari versions',\n                        'not dead',\n                        'not ie <= 11',\n                        'not op_mini all',\n                        'not android <= 4.4',\n                        'not samsung <= 4',\n                      ],\n                      node: '18',\n                    },\n                    useBuiltIns: false,\n                    modules,\n                  },\n                ],\n                require.resolve('@babel/preset-react'),\n                require.resolve('@babel/preset-typescript'),\n                require.resolve('@babel/preset-flow'),\n              ],\n            }),\n      });\n\n      if (result == null) {\n        throw new Error('Output code was null');\n      }\n\n      let code = result.code;\n\n      if (sourceMaps && result.map) {\n        const mapFilename = outputFilename + '.map';\n\n        code += '\\n//# sourceMappingURL=' + path.basename(mapFilename);\n\n        // Don't inline the source code, it can be retrieved from the source file\n        result.map.sourcesContent = undefined;\n\n        await fs.writeJSON(mapFilename, result.map);\n      }\n\n      await fs.writeFile(outputFilename, code);\n\n      if (copyFlow) {\n        fs.copy(filepath, outputFilename + '.flow');\n      }\n    })\n  );\n\n  report.success(`Wrote files to ${kleur.blue(path.relative(root, output))}`);\n\n  const getGeneratedEntryPath = async () => {\n    if (pkg.source) {\n      const indexName =\n        path.basename(pkg.source).replace(/\\.(jsx?|tsx?)$/, '') + '.js';\n\n      const potentialPath = path.join(\n        output,\n        path.dirname(path.relative(source, path.join(root, pkg.source))),\n        indexName\n      );\n\n      if (await fs.pathExists(potentialPath)) {\n        return path.relative(root, potentialPath);\n      }\n    }\n\n    return null;\n  };\n\n  if (field in pkg) {\n    try {\n      require.resolve(path.join(root, pkg[field]));\n    } catch (e: unknown) {\n      if (\n        e != null &&\n        typeof e === 'object' &&\n        'code' in e &&\n        e.code === 'MODULE_NOT_FOUND'\n      ) {\n        const generatedEntryPath = await getGeneratedEntryPath();\n\n        if (!generatedEntryPath) {\n          report.warn(\n            `Failed to detect the entry point for the generated files. Make sure you have a valid ${kleur.blue(\n              'source'\n            )} field in your ${kleur.blue('package.json')}.`\n          );\n        }\n\n        report.error(\n          `The ${kleur.blue(field)} field in ${kleur.blue(\n            'package.json'\n          )} points to a non-existent file: ${kleur.blue(\n            pkg[field]\n          )}.\\nVerify the path points to the correct file under ${kleur.blue(\n            path.relative(root, output)\n          )}${\n            generatedEntryPath\n              ? ` (found ${kleur.blue(generatedEntryPath)}).`\n              : '.'\n          }`\n        );\n\n        throw new Error(`Found incorrect path in '${field}' field.`);\n      }\n\n      throw e;\n    }\n  } else {\n    const generatedEntryPath = await getGeneratedEntryPath();\n\n    report.warn(\n      `No ${kleur.blue(field)} field found in ${kleur.blue(\n        'package.json'\n      )}. Consider ${\n        generatedEntryPath\n          ? `pointing it to ${kleur.blue(generatedEntryPath)}`\n          : 'adding it'\n      } so that consumers of your package can use it.`\n    );\n  }\n}\n"],"mappings":"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"}